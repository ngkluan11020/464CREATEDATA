DELIMITER $$

CREATE PROCEDURE RedeemClubcardPoints(
    IN p_CustomerID INT,       -- Customer ID
    IN p_RedeemPoints INT      -- Points to redeem
)
BEGIN
    DECLARE v_TotalPoints INT;
    DECLARE v_VoucherValue DECIMAL(10,2);
    DECLARE v_StatusMessage VARCHAR(255);

    -- Step 1: Check if customer has sufficient points
    SELECT Points_Balance INTO v_TotalPoints
    FROM Clubcard
    WHERE Customer_ID = p_CustomerID;

    IF v_TotalPoints < p_RedeemPoints THEN
        SET v_StatusMessage = CONCAT('Insufficient points. You need ', p_RedeemPoints - v_TotalPoints, ' more points.');
        SELECT v_StatusMessage AS Status;
        LEAVE RedeemClubcardPoints;
    END IF;

    -- Step 2: Calculate voucher value (e.g., 150 points = 1 voucher)
    SET v_VoucherValue = (p_RedeemPoints / 150);

    -- Step 3: Deduct points and update the balance
    UPDATE Clubcard
    SET Points_Balance = Points_Balance - p_RedeemPoints
    WHERE Customer_ID = p_CustomerID;

    -- Step 4: Insert voucher details into the Voucher table
    INSERT INTO Voucher (Customer_ID, Voucher_Value, Redemption_Date)
    VALUES (p_CustomerID, v_VoucherValue, NOW());

    -- Step 5: Record the transaction in PointsTransaction
    INSERT INTO PointsTransaction (Customer_ID, Transaction_Type, Points_Changed, Transaction_Date)
    VALUES (p_CustomerID, 'Redeem', -p_RedeemPoints, NOW());

    -- Step 6: Confirm successful redemption
    SET v_StatusMessage = CONCAT('Redemption successful! Voucher value: Â£', v_VoucherValue, '.');
    SELECT v_StatusMessage AS Status;
END$$

DELIMITER ;

